<!--
	24RF08 PASSWORD FINDER
	Copyright (c) 2022 Hi-Ban.

	This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.
    If not, see <https://www.gnu.org/licenses/gpl-3.0.en.html>.
-->

<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAlUlEQVR4nO2UwQ6AMAhDwfj/v4wHkjl1QOdc5oEeTelzGR0TCc3UNjU9AQlYABAh6azN0hOAP+vbTICOhYzQZgKYLxFOem3uAOiYTjYZ+rF4zBDkNbUO4UeroC1qBiHpKGBEEMC5gw8Az1XxL/+mvSu6FvP5crxZU2THka4ERQtXJbQFRUPk26avKdTkEf2jaAlIgKsD5FAvP3Lli5AAAAAASUVORK5CYII=">
	<title>24RF08 PASSWORD FINDER</title>
	<style type="text/css">

		body{
			font-family: 'Courier New', sans-serif;
			background-color: black;
			color: white;
			padding: 0px;
			margin: 0px;
			margin-top: 0px;
		}

		#mydiv{
			position: absolute;
			margin: auto;
			left: 50%;
			top: 50%;
			margin-top: -180px;
			margin-left: -310px;
			padding: 20px;
			background-color: blue;
			width: 580px;
			height: 300px;
			border-radius: 5px;
			text-align: center;
		}

		#results{
			margin: auto;
			padding: 10px;
			background-color: black;
			width: 540px;
			height: 100px;
			border-radius: 3px;
			color: #00ff00;
			text-align: left;
		}

		h1{
			text-align: center;
			width: 560px;
			margin-top: 5px;
			margin-left: 10px;
			border-radius: 3px;
			letter-spacing: 0.16em;
			text-shadow: 3px 3px #0000a0;
			color: lightblue;
		}

		input{
			width: 476px;
			background-color: #0000a0;
			border-radius: 3px;
		}

		button{
			width: 180px;
			height: 50px;
			margin: auto;
		}

	</style>
	<script type="text/javascript">

		var nopassword = "0000000000000000";
		var pass1234567 = "0203040506070823";
		var scancodes = ["02", "03", "04", "05", "06", "07", "08", "09", "0a", "0b", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "1e", "1f", "20", "21", "22", "23", "24", "25", "26", "27", "2c", "2d", "2e", "2f", "30", "31", "32", "00"];
		var qwerty = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "z", "x", "c", "v", "b", "n", "m", ""];
		var qwertz = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "q", "w", "e", "r", "t", "z", "u", "i", "o", "p", "a", "s", "d", "f", "g", "h", "j", "k", "l", "ö", "y", "x", "c", "v", "b", "n", "m", ""];
		var azerty = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "a", "z", "e", "r", "t", "y", "u", "i", "o", "p", "q", "s", "d", "f", "g", "h", "j", "k", "l", "m", "w", "x", "c", "v", "b", "n", ",", ""];

		function downloadToFile(filename, data) {
			var a = document.createElement("a");
			a.href = URL.createObjectURL(new Blob([Uint8Array.from(data, c => c.charCodeAt(0))]));
			a.download = filename;
			document.body.append(a);
			a.click();
			a.remove();
			URL.revokeObjectURL(a.href);
		}

		function padLeft(number, length) {
			var result = String(number);
			for(var i = result.length; i < length; ++i) {
				result = '0' + result;
			}
			return result;
		}

		function asciiToHex(str) {
			var result = '';
			for (var i=0; i<str.length; i++) {
				result += padLeft((str.charCodeAt(i).toString(16)), 2);
			}
			return result;
		}

		function hexToAscii(str){
			var result = '';
			for (x = 0; x < str.length; x += 2) {
				result += String.fromCharCode(parseInt(str.substr(x, 2), 16));
			}
			return result;    
		}

		function resetPass(str, mode){
			var result = '';
			if (mode == 0) {
				result = str.substr(0, 1648) + nopassword + nopassword + str.substr(1680, 368);
			} else if (mode == 1) {
				result = str.substr(0, 1648) + pass1234567 + pass1234567 + str.substr(1680, 368);
			}
			return result;    
		}

		function decodePass(str) {
			var result = '';
			var passchars = [str.substr(0, 2), str.substr(2, 2), str.substr(4, 2), str.substr(6, 2), str.substr(8, 2), str.substr(10, 2), str.substr(12, 2)];
			var srcchar = "A";
			var dstchar = "A";
			var characters = qwerty;
			if (document.getElementById("keyboard").value == "QWERTZ") {
				characters = qwertz;
			} else if (document.getElementById("keyboard").value == "AZERTY") {
				characters = azerty;
			}
			for (var i=0; i<passchars.length; i++) {
				for (var j=0; j<scancodes.length; j++) {
					srcchar = scancodes[j];
					dstchar = characters[j];
					passchars[i] = passchars[i].replace(srcchar, dstchar);
				}
			}
			result = passchars[0] + passchars[1] + passchars[2] + passchars[3] + passchars[4] + passchars[5] + passchars[6];
			return result;
		}

		function doMagic(){
			const [file] = document.querySelector('input[type=file]').files;
			const reader = new FileReader();
			reader.addEventListener("load", () => {
				var model = reader.result.substr(reader.result.indexOf("ThinkPad"), 16).replace(/[^A-Za-z0-9 ]/g,'');
				var mtype = reader.result.substr(reader.result.indexOf("±S") + 2, 4);
				var hexpass1 = asciiToHex(reader.result).substr(1648, 16);
				var hexpass2 = asciiToHex(reader.result).substr(1664, 16);
				var pass1 = decodePass(hexpass1);
				if (hexpass1 === hexpass2) {
					if (pass1.length > 7) {
						document.getElementById("results").innerHTML = "Model: " + model + "<br>Type: " + mtype + "<br>Password: Password is TCPA encrypted.<br>";
					} else if (pass1.length > 0) {
						document.getElementById("results").innerHTML = "Model: " + model + "<br>Type: " + mtype + "<br>Password: " + pass1 + "<br>";
					} else {
						document.getElementById("results").innerHTML = "Model: " + model + "<br>Type: " + mtype + "<br>Password: Password is disabled.<br>";
					}
				} else {
					document.getElementById("results").innerHTML = "Error: Unable to find valid password data.<br>";
				}
			}, false);
			if (file) {
				reader.readAsBinaryString(file);
			} else {
				document.getElementById("results").innerHTML = "No file loaded.<br>";
			}	
		}

		function doMagic2(){
			const [file] = document.querySelector('input[type=file]').files;
			const reader = new FileReader();
			reader.addEventListener("load", () => {
				document.getElementById("results").innerHTML = "New Password: 1234567.<br>Generating patched file...<br>";
				var model = reader.result.substr(reader.result.indexOf("ThinkPad"), 16).replace(/[^A-Za-z0-9 ]/g,'');
				var patchedfile = hexToAscii(resetPass(asciiToHex(reader.result), 1));
				var binfilename = model.replace(/ /g,'_') + "_1234567.bin";
				downloadToFile(binfilename, patchedfile);
			}, false);
			if (file) {
				reader.readAsBinaryString(file);
			} else {
				document.getElementById("results").innerHTML = "No file loaded.<br>";
			}	
		}

		function doMagic3(){
			const [file] = document.querySelector('input[type=file]').files;
			const reader = new FileReader();
			reader.addEventListener("load", () => {
				document.getElementById("results").innerHTML = "Password disabled.<br>Generating patched file...<br>";
				var model = reader.result.substr(reader.result.indexOf("ThinkPad"), 16).replace(/[^A-Za-z0-9 ]/g,'');
				var patchedfile = hexToAscii(resetPass(asciiToHex(reader.result), 0));
				var binfilename = model.replace(/ /g,'_') + "_NOPASSWORD.bin";
				downloadToFile(binfilename, patchedfile);
			}, false);
			if (file) {
				reader.readAsBinaryString(file);
			} else {
				document.getElementById("results").innerHTML = "No file loaded.<br>";
			}
		}

		function init(){			
		}

		window.onload = init;

	</script>
</head>
<body>
		<div id="mydiv">
			<h1>24RF08 PASSWORD FINDER</h1>
			<input id="binfile" type="file" name="binfile" accept=".bin"><select id="keyboard">
				<option value="QWERTY" >QWERTY</option>
				<option value="QWERTZ" >QWERTZ</option>
				<option value="AZERTY" >AZERTY</option>
			</select>
			<br><br>
			<div id="results">No file loaded.</div>
			<br>
			<button id="decodebutton" onclick="doMagic()">PASSWORD FIND</button>
			<button id="patchbutton" onclick="doMagic2()">PASSWORD 1234567</button>
			<button id="nopassbutton" onclick="doMagic3()">PASSWORD DISABLE</button>
			<br>
		</div>
</body>
</html>